<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus AI: Advanced General Intelligence</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --primary-color: #3b82f6; /* Tailwind blue-500 */
            --bg-dark: #0f172a; /* Tailwind slate-900 */
            --bg-card: #1e293b; /* Tailwind slate-800 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #e2e8f0; /* Tailwind slate-200 */
        }
        /* Custom scrollbar for chat area */
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #475569; /* Tailwind slate-600 */
            border-radius: 4px;
        }
        /* Custom spinner animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 sm:p-6 md:p-10">

    <header class="text-center mb-6 md:mb-10">
        <h1 class="text-3xl sm:text-4xl font-bold text-white tracking-wider flex items-center justify-center">
            <svg class="w-8 h-8 mr-3 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1v-3.25m-7.25 0H5.63l1.58-6.1c.42-1.61 1.9-2.73 3.56-2.73h2.46c1.66 0 3.14 1.12 3.56 2.73l1.58 6.1H16.5m-7.25 0V17"></path></svg>
            Nexus AI
        </h1>
        <p class="text-sm text-slate-400 mt-1">General Intelligence with Real-time Grounding</p>
    </header>

    <main class="flex-grow flex flex-col max-w-4xl w-full mx-auto bg-slate-800 rounded-xl shadow-2xl overflow-hidden">
        <!-- Chat Message Area -->
        <div id="chat-messages" class="flex-grow p-4 md:p-6 space-y-4 overflow-y-auto">
            <!-- Initial Welcome Message -->
            <div class="flex justify-start">
                <div class="bg-blue-600 p-3 rounded-lg rounded-tl-none shadow-md max-w-xs sm:max-w-md text-white">
                    <strong class="text-blue-200">Nexus AI</strong>
                    <p class="mt-1">Hello! I am Nexus AI, an advanced general intelligence system. I can answer complex questions by accessing real-time information from the web. What would you like to know today?</p>
                </div>
            </div>
            <!-- Messages will be injected here -->
        </div>

        <!-- Input and Loading Area -->
        <div class="p-4 md:p-6 border-t border-slate-700 bg-slate-900">
            <div id="error-message" class="text-red-400 text-sm mb-2 hidden"></div>
            <div class="flex items-end space-x-3">
                <textarea id="user-input"
                    class="flex-grow resize-none p-3 border border-slate-600 rounded-xl bg-slate-700 text-white placeholder-slate-400 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                    placeholder="Ask Nexus AI anything... (e.g., What are the latest developments in fusion energy?)"
                    rows="2"
                    onkeypress="handleKeyPress(event)"
                ></textarea>
                <button id="send-button" onclick="sendMessage()"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-[1.01] flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="send-text">Send</span>
                    <div id="loader" class="spinner hidden"></div>
                </button>
            </div>
            <p class="text-xs text-slate-500 mt-2">Press Enter to send, or Shift+Enter for a new line.</p>
        </div>
    </main>

    <script>
        // --- Firebase Configuration & API Setup (Placeholders - No Firebase used for this task) ---
        // For a general AI chat, we focus purely on the Generative API call.
        
        const apiKey = ""; // API key is provided at runtime if this is empty
        const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent';
        const sendButton = document.getElementById('send-button');
        const loader = document.getElementById('loader');
        const sendText = document.getElementById('send-text');
        const userInput = document.getElementById('user-input');
        const chatMessages = document.getElementById('chat-messages');
        const errorMessage = document.getElementById('error-message');

        // --- Utility Functions ---

        /**
         * Implements exponential backoff for API retries.
         * @param {string} url - The API endpoint URL.
         * @param {object} options - Fetch request options.
         * @param {number} maxRetries - Maximum number of retries.
         * @param {number} delay - Initial delay in milliseconds.
         * @returns {Promise<Response>} - The successful response object.
         */
        async function exponentialBackoffFetch(url, options, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 && i < maxRetries - 1) {
                        // Too Many Requests, retry with backoff
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential increase
                    } else {
                        throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw new Error(`Fetch failed after ${maxRetries} attempts: ${error.message}`);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        /**
         * Formats and displays a new message in the chat window.
         * @param {string} sender - 'user' or 'ai'.
         * @param {string} messageHtml - The HTML content of the message.
         */
        function displayMessage(sender, messageHtml) {
            const isUser = sender === 'user';
            const messageContainer = document.createElement('div');
            messageContainer.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            const baseClasses = "p-3 rounded-xl shadow-lg max-w-xs sm:max-w-md";
            
            if (isUser) {
                messageBubble.className = `${baseClasses} bg-blue-600 text-white rounded-br-none`;
            } else {
                messageBubble.className = `${baseClasses} bg-slate-700 text-white rounded-tl-none`;
                messageBubble.innerHTML = `<strong class="text-cyan-400">Nexus AI</strong><p class="mt-1">${messageHtml}</p>`;
            }

            if (isUser) {
                messageBubble.textContent = messageHtml;
            } else {
                // If it's AI, we already added the strong tag in the innerHTML above.
                messageBubble.querySelector('p').innerHTML = messageHtml;
            }

            messageContainer.appendChild(messageBubble);
            chatMessages.appendChild(messageContainer);
            
            // Scroll to the bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // --- Core AI Logic ---

        /**
         * Converts plain text with markdown to displayable HTML.
         * This handles basic newlines for better formatting.
         * @param {string} text - The raw text from the API.
         * @returns {string} - HTML formatted string.
         */
        function formatResponse(text) {
            // Basic Markdown conversion for bold, lists, and newlines
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\n/g, '<br>'); // Convert newlines to breaks
            return html;
        }

        /**
         * Displays the grounding sources as a clickable list.
         * @param {Array<object>} sources - Array of source objects with uri and title.
         */
        function displaySources(sources) {
            if (sources.length === 0) return '';

            let sourceHtml = '<div class="mt-3 pt-2 border-t border-slate-600">';
            sourceHtml += '<p class="text-sm font-semibold text-slate-400 mb-1">Sources:</p>';
            sourceHtml += '<ul class="list-disc ml-4 space-y-1 text-sm">';
            
            // Deduplicate sources based on URI
            const uniqueSources = Array.from(new Map(sources.map(s => [s.uri, s])).values());
            
            uniqueSources.forEach((source, index) => {
                const title = source.title || `Source ${index + 1}`;
                sourceHtml += `<li><a href="${source.uri}" target="_blank" class="text-blue-400 hover:text-blue-300 transition-colors underline">${title}</a></li>`;
            });
            sourceHtml += '</ul></div>';
            
            return sourceHtml;
        }

        /**
         * Main function to send the user's message to the Gemini API.
         */
        async function sendMessage() {
            const prompt = userInput.value.trim();
            if (!prompt) {
                userInput.focus();
                return;
            }

            // 1. Display user message
            displayMessage('user', prompt);
            userInput.value = ''; // Clear input
            errorMessage.classList.add('hidden');
            
            // 2. Set loading state
            sendButton.disabled = true;
            sendText.classList.add('hidden');
            loader.classList.remove('hidden');

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                // Enable Google Search for real-time grounding
                tools: [{ "google_search": {} }],
                // System instruction to define the AI's persona
                systemInstruction: {
                    parts: [{ text: "You are 'Nexus AI,' a highly advanced, general-purpose artificial intelligence designed to answer almost any question. Your responses must be informative, precise, and polite. Always format complex answers using clear paragraphs, bold important terms, and use markdown for readability. When citing sources, use the provided grounding information to ensure accuracy and trustworthiness." }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey // Included just in case the key is manually set
                },
                body: JSON.stringify(payload)
            };

            try {
                const response = await exponentialBackoffFetch(apiUrl + (apiKey ? `?key=${apiKey}` : ''), options);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                let aiText = "I'm sorry, I was unable to generate a response. Please try again.";
                let sources = [];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    aiText = candidate.content.parts[0].text;
                    
                    // Extract grounding sources
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri);
                    }
                }

                const formattedText = formatResponse(aiText);
                const sourceHtml = displaySources(sources);
                
                // 3. Display AI response
                displayMessage('ai', formattedText + sourceHtml);

            } catch (error) {
                console.error("Nexus AI Error:", error);
                errorMessage.textContent = `A communication error occurred: ${error.message}. Please try refreshing or check your prompt.`;
                errorMessage.classList.remove('hidden');
                
                // Display generic error message in chat bubble
                displayMessage('ai', 'I encountered a technical error while processing your request. Please try again.');
            } finally {
                // 4. Reset loading state
                sendButton.disabled = false;
                sendText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        /**
         * Handles the Enter key press for sending messages.
         */
        function handleKeyPress(event) {
            // Check if Shift + Enter is NOT pressed
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // Prevent new line
                sendMessage();
            }
        }

        // Initialize event listener for the textarea
        userInput.addEventListener('input', () => {
             // Dynamically adjust textarea height (optional, for better UX)
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight) + 'px';
        });

    </script>
</body>
</html>
